-- CRIO O BANCO E O SELECIONO PARA USO
CREATE DATABASE CHECKPOINT_2
USE CHECKPOINT_2

-- CRIO AS 5 TABELAS, INDICO AS CHAVES PRIMÁRIAS COM O PRIMARY KEY (NOME_COLUNA) EM CADA TABELA 
-- E FAÇO AS RELAÇÕES COM O FOREIGN KEY (CHAVE_ESTRANGEIRA) REFERENCES (TABELA_ORIGEM)

CREATE TABLE CLIENTE (
COD_CLIENTE INT NOT NULL auto_increment, 
NOME_CLIENTE VARCHAR(45),
CNPJ VARCHAR(14), 
CPF VARCHAR(11),
CONSTRAINT PRIMARY KEY (COD_CLIENTE)
);

CREATE TABLE CADASTRO_CLIENTE (
COD_CADASTRO_CLIENTE INT NOT NULL AUTO_INCREMENT,
COD_CLIENTE INT NOT NULL,
NOME_CLIENTE VARCHAR(200), 
CPF VARCHAR(11), 
CNPJ VARCHAR(14),
ENDERECO_CLIENTE VARCHAR(250),
TELEFONE_CLIENTE VARCHAR(11),
PRIMARY KEY (COD_CADASTRO_CLIENTE, NOME_CLIENTE),
FOREIGN KEY (COD_CLIENTE) REFERENCES CLIENTE(COD_CLIENTE)
);

CREATE TABLE COMPRAS (
COD_COMPRAS INT NOT NULL AUTO_INCREMENT,
VALOR_TOTAL INT,
COD_CLIENTE INT,
QUANT_PRODUTO INT,
PRIMARY KEY (COD_COMPRAS),
FOREIGN KEY (COD_CLIENTE) REFERENCES CLIENTE(COD_CLIENTE)
);

CREATE TABLE CADASTRO_PRODUTO (
COD_CADASTRO_PRODUTO INT NOT NULL AUTO_INCREMENT,
NOME_PRODUTO VARCHAR(150),
QUANTIDADE_ESTOQUE VARCHAR(45),
VALOR_COMPRA FLOAT,
CODIGO_BARRAS VARCHAR(25),
PRIMARY KEY (COD_CADASTRO_PRODUTO, NOME_PRODUTO, CODIGO_BARRAS)
);


CREATE TABLE PRODUTO (
COD_PRODUTO INT AUTO_INCREMENT, 
PRECO_VENDA FLOAT,
PRECO_PROMOCAO FLOAT,
NOME_PRODUTO VARCHAR(150),
CODIGO_BARRAS VARCHAR(25),
QUANTIDADE_ESTOQUE INT,
COD_CADASTRO_PRODUTO INT,
COD_COMPRAS INT,
PRIMARY KEY (COD_PRODUTO),
FOREIGN KEY (COD_CADASTRO_PRODUTO, NOME_PRODUTO, CODIGO_BARRAS) REFERENCES CADASTRO_PRODUTO(COD_CADASTRO_PRODUTO, NOME_PRODUTO,CODIGO_BARRAS),
FOREIGN KEY (COD_COMPRAS) REFERENCES COMPRAS(COD_COMPRAS)
);


-- INSIRO OS DADOS DE CADA COLUNA NA TABELA CLIENTE E CADASTRO_CLIENTE. COMO ELAS POSSUEM UMA RELAÇÃO  1:1

INSERT INTO CLIENTE(NOME_CLIENTE, COD_CLIENTE, CPF) VALUES ("FILIPE RODRIGUES SANTOS LIMA", 25 ,"12967592823");
INSERT INTO CLIENTE (NOME_CLIENTE, COD_CLIENTE, CPF ) VALUES ("DIOGO PERICLES DA SILVA", 1 ,"29098267811");
INSERT INTO CLIENTE (NOME_CLIENTE, COD_CLIENTE, CNPJ) VALUES ("CLORISVALDO MATERIAL DE CONSTRUÇÃO", 2 , "15832028000123");
INSERT INTO CLIENTE (NOME_CLIENTE, COD_CLIENTE,CPF) VALUES ("THIAGO MORGANO SOUSA PORTELA", 18 ,"87635913490");
INSERT INTO CLIENTE (NOME_CLIENTE, COD_CLIENTE,CPF) VALUES ("LUMENA CONKÁ DA SILVA GRAVE", 13 ,"29037543111");
INSERT INTO CLIENTE (NOME_CLIENTE, COD_CLIENTE,CNPJ) VALUES ("CLORISVALDO MATERIAL DE CONSTRUÇÃO", 2 ,"15832028000123");

SELECT * FROM CLIENTE

INSERT INTO CADASTRO_CLIENTE(NOME_CLIENTE, COD_CLIENTE, CPF, ENDERECO_CLIENTE, TELEFONE_CLIENTE) VALUES ("FILIPE RODRIGUES SANTOS LIMA", 25 ,12967592823,"AV. MARECHAL TEODORO, 51", "87999834369");
INSERT INTO CADASTRO_CLIENTE (NOME_CLIENTE, COD_CLIENTE, CPF, ENDERECO_CLIENTE, TELEFONE_CLIENTE) VALUES ("DIOGO PERICLES DA SILVA", 1 ,"29098267811", "RUA CLEONICE FONSECA, 71", "878831596");
INSERT INTO CADASTRO_CLIENTE (NOME_CLIENTE, COD_CLIENTE, CNPJ, ENDERECO_CLIENTE, TELEFONE_CLIENTE) VALUES ("CLORISVALDO MATERIAL DE CONSTRUÇÃO", 2 , "15832028000123", "AV. SOLISMÃO PROCEDENTE, 290", "81999039512");
INSERT INTO CADASTRO_CLIENTE (NOME_CLIENTE, COD_CLIENTE,CPF, ENDERECO_CLIENTE, TELEFONE_CLIENTE) VALUES ("THIAGO MORGANO SOUSA PORTELA", 18 ,"87635913490", "RUA SANTALICIA MARIA, 96", "87988654321");
INSERT INTO CADASTRO_CLIENTE (NOME_CLIENTE, COD_CLIENTE,CPF, ENDERECO_CLIENTE, TELEFONE_CLIENTE) VALUES ("LUMENA CONKÁ DA SILVA GRAVE", 13 ,"29037543111", "RUA VIZINHA DA CONKÁ, 66", "81999436567");
INSERT INTO CADASTRO_CLIENTE (NOME_CLIENTE, COD_CLIENTE,CNPJ, ENDERECO_CLIENTE, TELEFONE_CLIENTE) VALUES ("CLORISVALDO MATERIAL DE CONSTRUÇÃO", 2 ,"15832028000123", "AV. SOLISMÃO PROCEDENTE, 290", "81999039512");
SELECT * FROM CADASTRO_CLIENTE

-- FIZ UM SELECT PERSONALIZADO PARA ACHAR O NÚMERO QUE INICIA COM 81 (SÃO INCORRETOS)
-- ACHEI OS VALORES E ALTEREI PARA O NÚMERO DE TELEFONE CORRETO (INICIA COM 87)

select cod_cliente, telefone_cliente from cadastro_cliente
where telefone_cliente like '81%';

update cadastro_cliente
set telefone_cliente = 87999039512
where cod_cliente = 2;

update cadastro_cliente
set telefone_cliente = 87999436567
where cod_cliente = 13;

select telefone_cliente from cadastro_cliente -- CHECO SE ESTÁ TUDO CERTINHO --

-- SELECT PERSONALIZADO PARA PROCURAR DADOS DUPLICADOS UTILIZANDO O CPF/CNPJ PARA CONTAR.
SELECT CPF, COD_CADASTRO_CLIENTE,CNPJ, NOME_CLIENTE, COUNT(CNPJ), COUNT(CPF) FROM CADASTRO_CLIENTE
GROUP BY NOME_CLIENTE
HAVING COUNT(CNPJ) OR COUNT(CPF);
-- AO DESCOBRIR OS DADOS, SELECIONO O CPF/CNPJ E UTILIZO-O COMO CONDIÇÃO DE EXCLUSÃO
-- MAS LIMITANDO A EXCLUSÃO EM 1 PARA EVITAR EXCLUIR O DADO NÃO DUPLICADO.
DELETE FROM CADASTRO_CLIENTE
WHERE CNPJ = 15832028000123 LIMIT 1;


----- AQUI EU PERCEBI QUE EU NÃO FIZ O RELACIONAMENTO CERTO DA COLUNA CLIENTE E CADASTRO_CLIENTE (DEVE SER 1:N CADASTRO/CLIENTE)
----- MAS AO INSERIR A FK LÁ, NÃO CONSEGUI DELETAR A FK DE CADASTRO_CLIENTE E NEM CONSEGUI TRAZER OS VALORES PARA A TABELA CLIENTE... 
-- FICOU UMA BAGUNÇA, MAS ATENDI AOS 
ALTER TABLE CLIENTE
ADD COLUMN COD_CADASTRO_CLIENTE INT;

ALTER TABLE CLIENTE
ADD FOREIGN KEY (COD_CADASTRO_CLIENTE) REFERENCES CADASTRO_CLIENTE (COD_CADASTRO_CLIENTE);